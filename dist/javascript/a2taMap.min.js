var A2taMap={self:{},carte:{},carteDefaultCenter:[],carteDefaultZoom:"",criteresLabelRecherche:[],criteresIdRecherche:[],containerlistCriteres:{},inputCarteRechercheLibre:{},listAutocompleteResponse:{},init:function(e){self=this,self.carte=e,self.carteDefaultZoom=self.carte.options.zoom,self.carteDefaultCenter=self.carte.options.center,self.setZoomControl(),self.containerlistCriteres=$("#listCriteres"),self.inputCarteRechercheLibre=$("#input-carte-recherche-libre"),self.listAutocompleteResponse=$("#listAutocompleteResponse"),self.searchInit(),$(self.ready)},ready:function(){self.rechercheLibreNoResult()},searchInit:function(){var e=document.body.querySelector(".map-TabsSearch"),t=e.querySelector("#mapSearchCategoriesSection");e.querySelector("#mapTriggerCategories").addEventListener("click",(function(){buildScrollableElement(t)}),!1)},setZoomControl:function(){self.carte.options.zoomControl=!1,L.control.zoom({position:"bottomleft"}).addTo(self.carte)},rechercheLibreCb:function(e,t){var r=t.item.value,s=t.item.label;return-1==self.criteresIdRecherche.indexOf(r)&&(self.criteresLabelRecherche.push(s),self.criteresIdRecherche.push(r),self.afficherCriteres()),this.value="",!1},afficherCriteres:function(){for(var e='<ul class="o-list-bare c-carte__criteres">',t=0;t<self.criteresLabelRecherche.length;t++)e+='<li class="o-list-bare__item c-carte__critere"><span class="c-carte__critere-label">'+self.criteresLabelRecherche[t]+'</span><button id="critereDelete'+t+'" class="c-btn c-carte__critere-btn"></button></li>';e+="</ul>",self.containerlistCriteres.html(e),$(".c-carte__critere-btn").click((function(){var e=this.id.substring(13);self.criteresLabelRecherche.splice(e,1),self.criteresIdRecherche.splice(e,1),self.afficherCriteres()})),self.chargerGeoPoints()},chargerGeoPoints:function(){self.carte.removeAllMarkers();for(var e={id_association:[],id_mot:[],ville:[],limit:500},t=0;t<self.criteresIdRecherche.length;t++){var r=self.criteresIdRecherche[t].split(":");for(var s in e){var o=r[0],i=e[o].length;s===o&&(e[o][i]=r[1])}}var l=$.param(e);$.getJSON("http.api/collectionjson/associations?"+l).done((function(e){var t={id_association:[]};$.each(e.collection.items,(function(e,r){t.id_association[e]=r.data[0].value}));var r=$.param(t);$.getJSON("?page=gis_json&objets=associations_env&limit=500&"+r).done((function(e){self.parseJson(e),0==self.criteresIdRecherche.length&&self.carte.setView(self.carteDefaultCenter,self.carteDefaultZoom)}))})).fail((function(e,t,r){var s=self.getMessageNoResult();self.containerlistCriteres.append(s)}))},rechercheLibreNoResult:function(){var e=self.inputCarteRechercheLibre.outerWidth();self.inputCarteRechercheLibre.on("autocompleteresponse",(function(t,r){if(r.content.length)self.cancelMessageNoResult();else{var s=this.value;if(s){self.listAutocompleteResponse.css("width",e+"px");var o=self.getMessageNoResult(s);self.listAutocompleteResponse.html(o),$(this).on("blur",self.cancelMessageNoResult)}}}))},getMessageNoResult:function(e){var t="";return t='<div id="infoNoResult" class="c-message c-message--info">',t+=e?"Aucun résultat pour « "+e+" »":"Aucun résultat",t+="</div>"},cancelMessageNoResult:function(){$("#infoNoResult").css("display","none")},parseJson:function(e){var t=self.carte,r=[];t.markerCluster=L.markerClusterGroup(t.options.clusterOptions).addTo(t),$.each(e.features,(function(e,s){if("Point"===s.geometry.type&&s.geometry.coordinates[0]){var o=L.marker([s.geometry.coordinates[1],s.geometry.coordinates[0]]);t.setGeoJsonFeatureIcon(s,o),t.setGeoJsonFeaturePopup(s,o),o.feature=s,r.push(o)}})),t.markerCluster.addLayers(r);var s=t.markerCluster.getBounds();t.fitBounds(s,{maxZoom:16})}},buildScrollableElement=function(e){var t,r,s=e.firstElementChild,o=e.querySelector(".map-SearchScroll_Scrollbar"),i=e.querySelector(".map-SearchScroll_ScrollbarFill"),l=e.clientWidth,n=s.scrollWidth;i.style.transform="translate3d(0, 0, 0)",i.style.width=l/n*100+"%",i.clientWidth,i.style.zIndex=l>=n?-1:2,o.style.zIndex=l>=n?-1:1;const c=function(){i.style.transform="translate3d("+r+"px, 0, 0)"};s.addEventListener("scroll",(function(e){cancelAnimationFrame(t),r=l*(e.target.scrollLeft/n),t=requestAnimationFrame(c)}));o.addEventListener("mousedown",(function(e){s.scrollLeft=n*(e.offsetX/l)}),!1);var a=null;const u=function(e){e.preventDefault(),e.stopPropagation(),s.scrollLeft=n*((e.clientX-a)/l)},f=function(t){t.preventDefault(),t.stopPropagation(),e.removeEventListener("mousemove",u),e.removeEventListener("mouseup",u)};i.addEventListener("mousedown",(function(t){t.preventDefault(),t.stopPropagation(),a=t.offsetX+s.getBoundingClientRect().left,e.addEventListener("mousemove",u,!1),e.addEventListener("mouseup",f,!1)}),!1)};$.widget("ui.autocomplete",$.ui.autocomplete,{options:{delay:500,prefix:"",position:{of:"#listAutocompleteResponse"}},_renderItem:function(e,t){var r=t.label;return this.options.prefix&&(r=this.options.prefix+" "+r),$("<li>").append($("<a>").text(r)).appendTo(e)}});